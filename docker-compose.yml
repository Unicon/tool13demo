version: '3'
services:
  db:
    image: public.ecr.aws/o9c0t3w1/postgres:13
    environment:
      - POSTGRES_USER=lti13
      - POSTGRES_PASSWORD=lti13
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lti13"]
      interval: 5s
      timeout: 5s
      retries: 5

  lti-service:
    image: lti-service:travis-build-${TRAVIS_BUILD_NUMBER}
    build:
      context: ./
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/lti13
      - SPRING_DATASOURCE_USERNAME=lti13
      - SPRING_DATASOURCE_PASSWORD=lti13
      - AWS_REGION=us-west-2
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - oidc.publickey=-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA7BatQOcmS8yV1IBgVaMF\ntFQz2/8284v/6V/B79BrI/HoOSfqlWLAbIt61xoGuu42cQqlm8/k/3s9txTKB9Hk\nLK/1JmITnI22zgVAV54MQo6QSIkK9UTMru9puG/S9EHtodObKkYdtenUrwLaCmAJ\ndGJekx91LKpVs43VWJ9NdrfIZkGtvbyqiNHNpu201SVFC8QAwpLXIGXa1kJSGZCk\ncWbvXJ+X9ubhHbbNYiTpQ2A5xrRV73pdY3/ny5YRdkmtk+17P3uH08yCq7YTsjq8\nQ8ThgMU2supiY3k0cp6+NWB//RmSx1fKrvpHGf5YfN1iM5Ncs7jMIjx4s3ycxhEq\nG1VpT/Ul0A1xTlsdAwFIsOQ98Uxu52N14vshIkAHa7LKFv/rtXmrNtF5shav4tuY\nRBWL0ZECqXxGH0IZEBXFPAKJa1WbOGRB10SZaxNQhBuvUK7lwjqcGYgWUUimK5X2\nR4TeVPh0YNrTHvJpK1eDqIBiEx02xUoK/wLp5BdPXFKxev0GLCMK1ieEuXXj9pR5\n+dyMEET6ktPI96ZQ54GPgS3IupdOB1PLcNCeXUHUiynP6bu2goLvWkEd7sgbKKbV\noqciQgeZUcisePLwaTcCgJqqySou5p5fF0PB1kkbLv/i6U6mJEpYgaPESVxrqOe8\nwCPt4tdJXks73OqqF48BrdECAwEAAQ==\n-----END PUBLIC KEY-----
      - oidc.privatekey=-----BEGIN PRIVATE KEY-----\nMIIJRAIBADANBgkqhkiG9w0BAQEFAASCCS4wggkqAgEAAoICAQDsFq1A5yZLzJXU\ngGBVowW0VDPb/zbzi//pX8Hv0Gsj8eg5J+qVYsBsi3rXGga67jZxCqWbz+T/ez23\nFMoH0eQsr/UmYhOcjbbOBUBXngxCjpBIiQr1RMyu72m4b9L0Qe2h05sqRh216dSv\nAtoKYAl0Yl6TH3UsqlWzjdVYn012t8hmQa29vKqI0c2m7bTVJUULxADCktcgZdrW\nQlIZkKRxZu9cn5f25uEdts1iJOlDYDnGtFXvel1jf+fLlhF2Sa2T7Xs/e4fTzIKr\nthOyOrxDxOGAxTay6mJjeTRynr41YH/9GZLHV8qu+kcZ/lh83WIzk1yzuMwiPHiz\nfJzGESobVWlP9SXQDXFOWx0DAUiw5D3xTG7nY3Xi+yEiQAdrssoW/+u1eas20Xmy\nFq/i25hEFYvRkQKpfEYfQhkQFcU8AolrVZs4ZEHXRJlrE1CEG69QruXCOpwZiBZR\nSKYrlfZHhN5U+HRg2tMe8mkrV4OogGITHTbFSgr/AunkF09cUrF6/QYsIwrWJ4S5\ndeP2lHn53IwQRPqS08j3plDngY+BLci6l04HU8tw0J5dQdSLKc/pu7aCgu9aQR3u\nyBsoptWipyJCB5lRyKx48vBpNwKAmqrJKi7mnl8XQ8HWSRsu/+LpTqYkSliBo8RJ\nXGuo57zAI+3i10leSzvc6qoXjwGt0QIDAQABAoICAHbMim4IYrrtvc9qsg8ls28k\nl9vyNuKi5im3J83XILK7vdFVBrQZNx7nqO6oiA50ZCzJ4L/hAyiUCWAhM/Bva9QY\nztF7tMaogP52ogP04dJ0DqKRY1Q8RIsaqiZHDu4eZsdxxbimA7lQateOJc3muZs5\nDMIXqEzLgciSbHLl5oMAw/TAw/6f+2hRupxvLPm8gVwESyWd4mbJGi+Ku+llYXo3\nA+el30A8ubbMD9l9HWvr9ebJRBz3hBrXd/p4D11ogdHYRJaTQKwRUwe43XxoFeg8\nIAU+N+IcE1pe2Ud8HdaaMo1X2wY4ZSNbiX/I/xoGBK5TTuiY6w+nQk1/PRxl8rtK\n+lWhXbM5Io3fWPuLqQ2i9SfkdLj2a1lbBVOMqbVrsSFJ913P4dsTwQaFPpiObqfO\n/X+QjRafqeyoUYGspFIM7Nl+eBoDGg1yPxiBCSPzNRlbGmS8R0jeULM3NGw5pd+E\nGvQv4SPRqPUr657fPOR1s+/lgUmIzhiVR5+FvyjPjiprEXvOpast4HhNVMNNjdXT\nd4rOdUZ9Km8O2NE/V1QNsOSsJrBdwwl9Gu2pNtU1QtRaYuoC8rvwf/Wm4bXjEf7C\nih1o5stpSHONrpyYUSTzuaj/zTqGpVpqlgwQ4514O9PYafcSFZo5vivYJpkqEqBK\nDY9p/Yzz9Yh/QrkpzQWpAoIBAQD161pi5pE/tkvTIXfDBN1phH8S9ovmL1VHY1sJ\nm/MhbXO2OWelKUsOp07m6vGeywMAvWFQWOMV5dQBlo7kBnTXDqrV5jqDccuz7LxU\nACiav4jEhWThE1PWU7yNol25sLKm5OdJmjpR4SlCo5Qjl56SpH36vkdTtXRN302c\nBJs4SR2FKbIsqrgZq/QTunFH8T4g6Eygu1wuQNKVWhvWB//vEK7A3///ZQIF3/UI\ngKJC4aDAKixQizFPXU+Us/ixDliGu33cZ0SU9QIs/kLqZqdM055ai4/SrXgEUcMG\n7mxTaiuoZPujKhVkh0WtELrPypJ43oqPvTsfoBCkVUX2NCBzAoIBAQD1xCkuLMPx\noI/oO+vWgNy/fwhb7pat4i7Sqa8KGaqcdVTQQD1o8ww+T5U9HNF2346SYc1fyWgn\nfl1GdGxPtaDL8bCHRWQC2BVIIpvGLc44CUjyR+XQTeAHWwOVVleWLGPeZ8gM7Sf1\nAxvjV2ZmRecZsK8Y/a1gXFTKvpGYkVwmmmdtDmZOXM/TGdpAUughwKU970M669mF\nbvXvuZPqrr4U3s+DT6wZLMrbajjO1aM5D3dRGXHlOUWIYbKh10aHMPUa0iwOuFw5\n6ZLjjT9JwQ26GFZxIe5zIybdEIqwXJ9ul6rAxgexKLUBLgkV2eMshNhRujUGSUb5\n2HfTSxyslLurAoIBAQC1tW63D1kZ87A5VExy3GBh/FYNBAHBVw4zTpXRFttiwsYy\nSl5sKoPcUwG5HLbmN2mDnWuPe+5nmse5WK9CjAa/dYYDwTdRMr9qti0+AFQAbDA5\nzbsJmEdlYcA8A1IvyAFp0k+YEg6vu6jKJaZrWjgAcOzpXrnDf5ttgueMtdafk17t\nqy6NVKPtzCHwhd34Y6gdlqgwR+DICHvRgaB52LVixzfpKlq1MsR45M/gtXOv6Znn\nBAJ0jTUlSHRqE0VaRphhDZ7lQaTqT9OIvWNiYfGSkfc7Pk5KRIUe4+8wavG9/QA/\nUEajfJAMFOwGAguXSD5Mc1t89D0AlDxXwO6OClxDAoIBAQDbFqa7Ug7PPRpspdZE\n35VqZN1XzuamVib1h2zSLTVJytLz3wCfqWN1vM5Gr4UPWpWnauaBiHOAGYcfQrQ3\njqusg2WiATr5yhWWu7twPO9ERwqvaWa2fmXDSOB15YWpCyNwZcYRt+zR35ah4Q0Z\nCSHOZhKBzcscRtMT9jSm9JZYl3ax4o9TNivSfY5xnzbut+TWxI+DXDMKX3OA5Ee3\ng1VSF5qX7ZN20dZ5KUVBJXQfbukn8+3zsU2KGcX7voRSClPGOCwsZy9YNR/MGOOd\nZStOhVmx+tSt8V043wEz3S4Hkc8XkLHUvXw2dAqHXzjEPBz3Jm8UjohmPBH920zR\nkLmHAoIBAQDzQepagL8v8pKsYKobuPjeTjcGIZznLKzYXTVhprEpElFdEW3lT7ez\nqpiNsR46frOaTpQuW75EYV4hP1XCoMgop9GMSATHcGHeoAlyLza05H1+fHX0lSdz\nDVBvUMPt3Tg4tJx2GKuh8OyZHVwUefNA5xOorTASo2VieivFtI9VUjzXNiuQDYuB\nePTTEe/o539SGKhYnUva7Y6c8XJNrskIcOLvuBhNedfzQnfBEOs2ppfy8ILyNX4T\nEE4HyZaNaEch7U1rPNETcT8E4uIxwr/L8BYOZM1wj2udvbHFP4QA+aVB5RvhkMRk\nszrzD28u5EghT/DO+ZH4d9zCD+kumd8l\n-----END PRIVATE KEY-----
    depends_on:
      db:
        condition: service_healthy